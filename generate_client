#!/bin/bash

if [[ "$1" == "" ]]; then
    echo "Please specify the name of the cluster as an argument."
    exit 1
fi

CGEN_NAME="swagger-codegen-cli"
CGEN_VER="2.4.5"  # For 3.x use CGEN_VER="3.0.7"
CGEN_JAR_NAME="${CGEN_NAME}-${CGEN_VER}.jar"
CGEN_JAR_URL="https://search.maven.org/remotecontent?filepath=\
io/swagger/swagger-codegen-cli/${CGEN_VER}/${CGEN_JAR_NAME}"
# io/swagger/codegen/v3/swagger-codegen-cli/${CGEN_VER}/${CGEN_JAR_NAME}"
# Uncomment above if you'd like to use swagger-codegen-cli version 3.x

CONFIG_FILE=".swagger-codegen/config.json"
EXTRA_PROPS="basePath=https://YOUR_INSTANCE.wavefront.com"
EXTRA_PROPS+=",infoEmail=chitimba@wavefront.com"

SWGR_JSON="swagger.json"
SWGR_URL="https://$1.wavefront.com/api/v2/${SWGR_JSON}"
VERSION_URL="https://$1.wavefront.com/auth/forgetPassword"

PYTHON=$(command -v python3 || command -v python)

if [[ -z "$($PYTHON -V | grep 'Python 3')" ]]; then
  echo "Obsolete Python version found. Please update."
  exit 1
elif [[ -z "$(command -v curl)" ]]; then
  echo "The curl command was not found on the system."
  exit 1
fi

# Check if config file exists in '.swagger-codegen' directory.
[[ -f "${CONFIG_FILE}" ]] || echo "Config file '${CONFIG_FILE}' not found!"
# Get the current version from the config file.
CONFIG_VER=$($PYTHON -c "import json, sys;\
  sys.stdout.write(json.load(sys.stdin)['packageVersion'][2:]+'\n')"\
  < "${CONFIG_FILE}"
)
echo "Fetching the current version from '$1' cluster..."
SERVER_VER=$(curl -s "${VERSION_URL}" | grep 'version: ' | \
             grep -o '[0-9]\+\.[0-9]\+')

echo "Current Version on server is: ${SERVER_VER}"
echo "Current Version in config is: ${CONFIG_VER}"

if [[ -z "${CONFIG_VER}" || -z "${SERVER_VER}" ]]; then
  echo "Unable to determine the version for '$1' cluster."
  exit 1
elif [[ "${CONFIG_VER}" == "${SERVER_VER}" ]]; then
  echo "No Version Change Detected. Bye."
else
  echo "Version change detected from ${CONFIG_VER} to ${SERVER_VER}..."
  TEMP_DIR_NAME="$(mktemp -d)"
  SWAGGER_FILE="${TEMP_DIR_NAME}/${SWGR_JSON}"
  CGEN_JAR_BINARY="${TEMP_DIR_NAME}/${CGEN_JAR_NAME}"

  echo "Step 1: Fetching the latest swagger-codegen..."
  curl -s "${CGEN_JAR_URL}" -o "${CGEN_JAR_BINARY}"

  echo "Step 2: Fetching the latest swagger.json..."
  curl -s "${SWGR_URL}" | $PYTHON -m json.tool --sort-keys > "${SWAGGER_FILE}"

  if [[ ! -f "${SWAGGER_FILE}" ]]; then  # swagger file not found
      echo "Failed to fetch swagger.json... Aborting..."
      exit 1
  fi

  echo "Step 3: Generating the client..."
  java -jar "${CGEN_JAR_BINARY}" generate -l python \
       -c "${CONFIG_FILE}" -i "${SWAGGER_FILE}" \
       --additional-properties "${EXTRA_PROPS}"

  echo "Step 4: Checking if anything has changed..."
  if [[ -n "$(git status --porcelain)" ]]; then  # non-zero diff detected.
    echo "Step 5: Updating the version in the config..."
    sed -i '' "s/${CONFIG_VER//./\\.}/${SERVER_VER//./\\.}/" "${CONFIG_FILE}"

    echo "Step 6: Generating the updated client..."
    java -jar "${CGEN_JAR_BINARY}" generate -l python \
         -c "${CONFIG_FILE}" -i "${SWAGGER_FILE}" \
         --additional-properties "${EXTRA_PROPS}"

    echo "Step 7: Committing the updated files..."
    git add -A && git commit -am "Autogenerated Update v2.${SERVER_VER}."

    echo "Please run git push in order to push commit to GitHub... Bye."
  fi
  echo "Cleaning up..."
  rm -rv "${TEMP_DIR_NAME}"
fi
